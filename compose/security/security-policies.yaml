# Security Policies for Xorb PTaaS Docker Compose
# Comprehensive security hardening configuration

version: "1.0"

# AppArmor profiles for containers
apparmor:
  default_profile: "docker-default"
  custom_profiles:
    xorb_api:
      - "deny /proc/sys/kernel/core_pattern w"
      - "deny /sys/devices/virtual/powercap/** w"
      - "deny /sys/kernel/debug/** rw"
    xorb_scanner:
      - "allow /tmp/xorb/scanner_data/** rw"
      - "deny /home/** r"
      - "deny /root/** r"

# SELinux contexts (if SELinux is enabled)
selinux:
  enabled: false
  contexts:
    api: "system_u:system_r:container_t:s0"
    worker: "system_u:system_r:container_t:s0:c1"
    scanner: "system_u:system_r:container_t:s0:c2"

# Seccomp profiles for syscall filtering
seccomp:
  default_action: "SCMP_ACT_ERRNO"
  allowed_syscalls:
    - "read"
    - "write"
    - "open"
    - "close"
    - "stat"
    - "fstat"
    - "lstat"
    - "poll"
    - "lseek"
    - "mmap"
    - "mprotect"
    - "munmap"
    - "brk"
    - "rt_sigaction"
    - "rt_sigprocmask"
    - "rt_sigreturn"
    - "ioctl"
    - "pread64"
    - "pwrite64"
    - "readv"
    - "writev"
    - "access"
    - "pipe"
    - "select"
    - "sched_yield"
    - "mremap"
    - "msync"
    - "mincore"
    - "madvise"
    - "shmget"
    - "shmat"
    - "shmctl"
    - "dup"
    - "dup2"
    - "pause"
    - "nanosleep"
    - "getitimer"
    - "alarm"
    - "setitimer"
    - "getpid"
    - "sendfile"
    - "socket"
    - "connect"
    - "accept"
    - "sendto"
    - "recvfrom"
    - "sendmsg"
    - "recvmsg"
    - "shutdown"
    - "bind"
    - "listen"
    - "getsockname"
    - "getpeername"
    - "socketpair"
    - "setsockopt"
    - "getsockopt"
    - "clone"
    - "fork"
    - "vfork"
    - "execve"
    - "exit"
    - "wait4"
    - "kill"
    - "uname"
    - "semget"
    - "semop"
    - "semctl"
    - "shmdt"
    - "msgget"
    - "msgsnd"
    - "msgrcv"
    - "msgctl"
    - "fcntl"
    - "flock"
    - "fsync"
    - "fdatasync"
    - "truncate"
    - "ftruncate"
    - "getdents"
    - "getcwd"
    - "chdir"
    - "fchdir"
    - "rename"
    - "mkdir"
    - "rmdir"
    - "creat"
    - "link"
    - "unlink"
    - "symlink"
    - "readlink"
    - "chmod"
    - "fchmod"
    - "chown"
    - "fchown"
    - "lchown"
    - "umask"
    - "gettimeofday"
    - "getrlimit"
    - "getrusage"
    - "sysinfo"
    - "times"
    - "ptrace"
    - "getuid"
    - "syslog"
    - "getgid"
    - "setuid"
    - "setgid"
    - "geteuid"
    - "getegid"
    - "setpgid"
    - "getppid"
    - "getpgrp"
    - "setsid"
    - "setreuid"
    - "setregid"
    - "getgroups"
    - "setgroups"
    - "setresuid"
    - "getresuid"
    - "setresgid"
    - "getresgid"
    - "getpgid"
    - "setfsuid"
    - "setfsgid"
    - "getsid"
    - "capget"
    - "capset"
    - "rt_sigpending"
    - "rt_sigtimedwait"
    - "rt_sigqueueinfo"
    - "rt_sigsuspend"
    - "sigaltstack"
    - "utime"
    - "mknod"
    - "uselib"
    - "personality"
    - "ustat"
    - "statfs"
    - "fstatfs"
    - "sysfs"
    - "getpriority"
    - "setpriority"
    - "sched_setparam"
    - "sched_getparam"
    - "sched_setscheduler"
    - "sched_getscheduler"
    - "sched_get_priority_max"
    - "sched_get_priority_min"
    - "sched_rr_get_interval"
    - "mlock"
    - "munlock"
    - "mlockall"
    - "munlockall"
    - "vhangup"
    - "modify_ldt"
    - "pivot_root"
    - "_sysctl"
    - "prctl"
    - "arch_prctl"
    - "adjtimex"
    - "setrlimit"
    - "chroot"
    - "sync"
    - "acct"
    - "settimeofday"
    - "mount"
    - "umount2"
    - "swapon"
    - "swapoff"
    - "reboot"
    - "sethostname"
    - "setdomainname"
    - "iopl"
    - "ioperm"
    - "create_module"
    - "init_module"
    - "delete_module"
    - "get_kernel_syms"
    - "query_module"
    - "quotactl"
    - "nfsservctl"
    - "getpmsg"
    - "putpmsg"
    - "afs_syscall"
    - "tuxcall"
    - "security"
    - "gettid"
    - "readahead"
    - "setxattr"
    - "lsetxattr"
    - "fsetxattr"
    - "getxattr"
    - "lgetxattr"
    - "fgetxattr"
    - "listxattr"
    - "llistxattr"
    - "flistxattr"
    - "removexattr"
    - "lremovexattr"
    - "fremovexattr"
    - "tkill"
    - "time"
    - "futex"
    - "sched_setaffinity"
    - "sched_getaffinity"
    - "set_thread_area"
    - "io_setup"
    - "io_destroy"
    - "io_getevents"
    - "io_submit"
    - "io_cancel"
    - "get_thread_area"
    - "lookup_dcookie"
    - "epoll_create"
    - "epoll_ctl_old"
    - "epoll_wait_old"
    - "remap_file_pages"
    - "getdents64"
    - "set_tid_address"
    - "restart_syscall"
    - "semtimedop"
    - "fadvise64"
    - "timer_create"
    - "timer_settime"
    - "timer_gettime"
    - "timer_getoverrun"
    - "timer_delete"
    - "clock_settime"
    - "clock_gettime"
    - "clock_getres"
    - "clock_nanosleep"
    - "exit_group"
    - "epoll_wait"
    - "epoll_ctl"
    - "tgkill"
    - "utimes"
    - "vserver"
    - "mbind"
    - "set_mempolicy"
    - "get_mempolicy"
    - "mq_open"
    - "mq_unlink"
    - "mq_timedsend"
    - "mq_timedreceive"
    - "mq_notify"
    - "mq_getsetattr"
    - "kexec_load"
    - "waitid"
    - "add_key"
    - "request_key"
    - "keyctl"
    - "ioprio_set"
    - "ioprio_get"
    - "inotify_init"
    - "inotify_add_watch"
    - "inotify_rm_watch"
    - "migrate_pages"
    - "openat"
    - "mkdirat"
    - "mknodat"
    - "fchownat"
    - "futimesat"
    - "newfstatat"
    - "unlinkat"
    - "renameat"
    - "linkat"
    - "symlinkat"
    - "readlinkat"
    - "fchmodat"
    - "faccessat"
    - "pselect6"
    - "ppoll"
    - "unshare"
    - "set_robust_list"
    - "get_robust_list"
    - "splice"
    - "tee"
    - "sync_file_range"
    - "vmsplice"
    - "move_pages"
    - "utimensat"
    - "epoll_pwait"
    - "signalfd"
    - "timerfd_create"
    - "eventfd"
    - "fallocate"
    - "timerfd_settime"
    - "timerfd_gettime"
    - "accept4"
    - "signalfd4"
    - "eventfd2"
    - "epoll_create1"
    - "dup3"
    - "pipe2"
    - "inotify_init1"
    - "preadv"
    - "pwritev"
    - "rt_tgsigqueueinfo"
    - "perf_event_open"
    - "recvmmsg"
    - "fanotify_init"
    - "fanotify_mark"
    - "prlimit64"
    - "name_to_handle_at"
    - "open_by_handle_at"
    - "clock_adjtime"
    - "syncfs"
    - "sendmmsg"
    - "setns"
    - "getcpu"
    - "process_vm_readv"
    - "process_vm_writev"
    - "kcmp"
    - "finit_module"

# Container resource limits
resource_limits:
  memory:
    api: "3g"
    worker: "6g"
    orchestrator: "1g"
    scanner: "2g"
    triage: "2g"
    payments: "512m"
    scheduler: "512m"
    researcher_portal: "1g"
  
  cpu:
    api: "3.0"
    worker: "4.0"
    orchestrator: "1.0"
    scanner: "1.0"
    triage: "1.0"
    payments: "0.5"
    scheduler: "0.5"
    researcher_portal: "0.5"

# Network security
network:
  internal_networks:
    - "xorb-network"
  
  exposed_ports:
    api: 8000
    orchestrator: 8001
    payments: 8002
    researcher_portal: 3000
    nats: 4222
    temporal: 7233
  
  firewall_rules:
    - "ACCEPT tcp 8000 from any"  # API
    - "ACCEPT tcp 3000 from any"  # Portal
    - "DENY tcp 5432 from any"    # Postgres - internal only
    - "DENY tcp 6379 from any"    # Redis - internal only

# File system security
filesystem:
  read_only_containers:
    - "api"
    - "orchestrator"
    - "triage"
    - "payments"
    - "researcher-portal"
  
  tmpfs_mounts:
    api: "/tmp:exec,size=500m"
    worker: "/tmp:exec,size=2g"
    orchestrator: "/tmp:exec,size=200m"
    scanner: "/tmp:exec,size=1g"
    triage: "/tmp:exec,size=500m"
    payments: "/tmp:exec,size=100m"
    scheduler: "/tmp:exec,size=100m"
    researcher_portal: "/tmp:exec,size=200m"

# Audit and logging
audit:
  enabled: true
  log_level: "INFO"
  log_format: "json"
  
  events:
    - "container_start"
    - "container_stop"
    - "network_connect"
    - "file_access"
    - "process_exec"
    - "capability_use"
  
  destinations:
    - "syslog"
    - "file:/var/log/xorb/security.log"