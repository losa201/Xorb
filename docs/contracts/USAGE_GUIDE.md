# Using the Contract Compatibility System

This guide explains how to use the contract compatibility checking system in your development workflow.

## Prerequisites

Install the required dependencies:

```bash
make install-contract-deps
```

This installs:
- `buf` - For advanced Protobuf compatibility checking
- `protoc` - For Protobuf descriptor generation
- `pyyaml` - For YAML parsing in Python

## Local Development Workflow

### 1. Check Compatibility Before Committing

Before committing changes to contract files, check for compatibility:

```bash
make contract-check
```

This will run both Protobuf and OpenAPI compatibility checks and report any breaking changes.

### 2. View Detailed Reports

To view detailed reports in a human-readable format:

```bash
make contract-report
```

This will display the Markdown reports generated by the compatibility checks.

### 3. Understanding the Reports

Reports are generated in two formats:
- JSON (`tools/contracts/reports/*.json`) - For programmatic consumption
- Markdown (`tools/contracts/reports/*.md`) - For human reading

Each report includes:
- **What** changed (specific field, endpoint, etc.)
- **Where** the change occurred (file path, endpoint path, etc.)
- **Why** it's considered breaking
- **Suggested Fix** to resolve the issue

## CI/CD Integration

The compatibility checks automatically run on pull requests that modify:
- `.proto` files in the `proto/` directory
- `docs/api/xorb-openapi-spec.yaml`

If breaking changes are detected:
1. The PR will be blocked from merging
2. A comment will be posted summarizing the issues
3. Detailed reports will be available as workflow artifacts

## Handling Breaking Changes

When the system detects breaking changes, you have two options:

### Option 1: Fix the Breaking Changes (Recommended)

Review the reports and modify your changes to maintain backward compatibility:

- Instead of removing fields, mark them as deprecated
- Instead of making fields required, provide default values
- Add new endpoints rather than modifying existing ones

### Option 2: Intentional Breaking Change with Migration Path

If you must introduce breaking changes:
1. Document the breaking changes clearly
2. Provide a migration guide for clients
3. Consider versioning your APIs appropriately
4. Get explicit approval from maintainers

## Example Workflow

Here's a typical workflow when modifying contracts:

```bash
# 1. Make changes to .proto or OpenAPI files
# Edit proto/audit/v1/evidence.proto or docs/api/xorb-openapi-spec.yaml

# 2. Check for compatibility issues
make contract-check

# 3. If breaking changes are found, review the reports
make contract-report

# 4. Fix any breaking changes or document intentional ones

# 5. Commit and push changes
git add .
git commit -m "Update evidence proto with new fields"
git push

# 6. Create PR - CI will automatically check for compatibility
```

## Pre-commit Hook

A pre-commit hook is installed that will warn you if you're committing contract files. While it doesn't perform full compatibility checking (for performance), it reminds you to run the checks before pushing.

To manually run the pre-commit hook:
```bash
.git/hooks/pre-commit
```

## Troubleshooting

### "buf not found" or "protoc not found" Errors

Install the required dependencies:
```bash
make install-contract-deps
```

### Reports Not Generated

Ensure the reports directory exists:
```bash
mkdir -p tools/contracts/reports
```

### False Positives

If you believe a reported breaking change is not actually breaking, please:
1. Double-check against the definitions in `docs/contracts/COMPATIBILITY_GATES.md`
2. Consult with the team
3. If it's truly a false positive, file an issue to improve the detection logic

## Advanced Usage

### Running Individual Checks

You can run the checks separately:

```bash
# Run only Protobuf compatibility check
python3 tools/contracts/check_proto_compat.py

# Run only OpenAPI compatibility check
python3 tools/contracts/check_openapi_compat.py
```

### Customizing Report Output

The tools generate reports in both JSON and Markdown formats. You can modify the reporting logic in the respective check scripts if you need different formats.

### Integration with Other Tools

The JSON reports can be integrated with other tools in your development pipeline:
- Dashboard visualization
- Slack notifications
- Integration with issue trackers