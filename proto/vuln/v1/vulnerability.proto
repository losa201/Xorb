syntax = "proto3";

package xorb.vuln.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "audit/v1/evidence.proto";

option go_package = "github.com/xorb/proto/vuln/v1;vulnv1";

// VulnerabilityEvidence represents a security vulnerability finding with chain of custody
message VulnerabilityEvidence {
  // Core evidence metadata
  xorb.audit.v1.ChainOfCustody chain_of_custody = 1;
  string evidence_id = 2;
  string tenant_id = 3;
  google.protobuf.Timestamp created_at = 4;
  
  // Vulnerability data
  Vulnerability vulnerability = 5;
  VulnerabilityContext context = 6;
  repeated VulnerabilityReference references = 7;
  VulnerabilityAssessment assessment = 8;
  
  // Evidence integrity
  string digital_signature = 9;
  string hash_chain = 10;
  repeated string witness_signatures = 11;
}

// Core vulnerability information
message Vulnerability {
  string vuln_id = 1;
  string cve_id = 2;
  string title = 3;
  string description = 4;
  VulnerabilitySeverity severity = 5;
  float cvss_v3_score = 6;
  string cvss_v3_vector = 7;
  float cvss_v4_score = 8;
  string cvss_v4_vector = 9;
  VulnerabilityType vuln_type = 10;
  VulnerabilityState state = 11;
  google.protobuf.Timestamp published_date = 12;
  google.protobuf.Timestamp modified_date = 13;
  repeated string cwe_ids = 14;
  google.protobuf.Struct metadata = 15;
}

// Vulnerability discovery and scanning context
message VulnerabilityContext {
  string asset_id = 1;
  string asset_name = 2;
  AssetType asset_type = 3;
  repeated string affected_components = 4;
  repeated string affected_versions = 5;
  string discovery_method = 6;
  string scanner_tool = 7;
  string scanner_version = 8;
  google.protobuf.Timestamp scan_date = 9;
  ScanConfidence confidence = 10;
  bool false_positive = 11;
  string false_positive_reason = 12;
  google.protobuf.Struct scan_details = 13;
}

// Vulnerability references and external data
message VulnerabilityReference {
  ReferenceType type = 1;
  string url = 2;
  string source = 3;
  string description = 4;
  google.protobuf.Timestamp date = 5;
  string tags = 6;
}

// Vulnerability risk assessment and business impact
message VulnerabilityAssessment {
  float risk_score = 1; // 0.0 - 10.0
  RiskLevel risk_level = 2;
  BusinessImpact business_impact = 3;
  ExploitabilityLevel exploitability = 4;
  bool exploit_available = 5;
  bool in_the_wild = 6;
  string threat_intelligence = 7;
  repeated string mitigation_steps = 8;
  repeated string remediation_actions = 9;
  RemediationPriority priority = 10;
  google.protobuf.Timestamp due_date = 11;
  string assigned_to = 12;
  string analyst_id = 13;
  google.protobuf.Timestamp assessed_at = 14;
}

// Enumerations
enum VulnerabilitySeverity {
  VULNERABILITY_SEVERITY_UNSPECIFIED = 0;
  VULNERABILITY_SEVERITY_INFORMATIONAL = 1;
  VULNERABILITY_SEVERITY_LOW = 2;
  VULNERABILITY_SEVERITY_MEDIUM = 3;
  VULNERABILITY_SEVERITY_HIGH = 4;
  VULNERABILITY_SEVERITY_CRITICAL = 5;
}

enum VulnerabilityType {
  VULNERABILITY_TYPE_UNSPECIFIED = 0;
  VULNERABILITY_TYPE_INJECTION = 1;
  VULNERABILITY_TYPE_AUTHENTICATION = 2;
  VULNERABILITY_TYPE_SESSION_MANAGEMENT = 3;
  VULNERABILITY_TYPE_ACCESS_CONTROL = 4;
  VULNERABILITY_TYPE_SECURITY_MISCONFIGURATION = 5;
  VULNERABILITY_TYPE_SENSITIVE_DATA_EXPOSURE = 6;
  VULNERABILITY_TYPE_INSUFFICIENT_ATTACK_PROTECTION = 7;
  VULNERABILITY_TYPE_CSRF = 8;
  VULNERABILITY_TYPE_KNOWN_VULNERABILITY = 9;
  VULNERABILITY_TYPE_INSUFFICIENT_LOGGING = 10;
  VULNERABILITY_TYPE_BUFFER_OVERFLOW = 11;
  VULNERABILITY_TYPE_PRIVILEGE_ESCALATION = 12;
  VULNERABILITY_TYPE_DENIAL_OF_SERVICE = 13;
  VULNERABILITY_TYPE_CRYPTOGRAPHIC = 14;
}

enum VulnerabilityState {
  VULNERABILITY_STATE_UNSPECIFIED = 0;
  VULNERABILITY_STATE_NEW = 1;
  VULNERABILITY_STATE_CONFIRMED = 2;
  VULNERABILITY_STATE_IN_PROGRESS = 3;
  VULNERABILITY_STATE_REMEDIATED = 4;
  VULNERABILITY_STATE_VERIFIED = 5;
  VULNERABILITY_STATE_FALSE_POSITIVE = 6;
  VULNERABILITY_STATE_ACCEPTED_RISK = 7;
  VULNERABILITY_STATE_DEFERRED = 8;
}

enum AssetType {
  ASSET_TYPE_UNSPECIFIED = 0;
  ASSET_TYPE_WEB_APPLICATION = 1;
  ASSET_TYPE_MOBILE_APPLICATION = 2;
  ASSET_TYPE_NETWORK_DEVICE = 3;
  ASSET_TYPE_SERVER = 4;
  ASSET_TYPE_DATABASE = 5;
  ASSET_TYPE_CONTAINER = 6;
  ASSET_TYPE_CLOUD_RESOURCE = 7;
  ASSET_TYPE_IOT_DEVICE = 8;
  ASSET_TYPE_ENDPOINT = 9;
}

enum ScanConfidence {
  SCAN_CONFIDENCE_UNSPECIFIED = 0;
  SCAN_CONFIDENCE_UNKNOWN = 1;
  SCAN_CONFIDENCE_LOW = 2;
  SCAN_CONFIDENCE_MEDIUM = 3;
  SCAN_CONFIDENCE_HIGH = 4;
  SCAN_CONFIDENCE_CONFIRMED = 5;
}

enum ReferenceType {
  REFERENCE_TYPE_UNSPECIFIED = 0;
  REFERENCE_TYPE_CVE = 1;
  REFERENCE_TYPE_CWE = 2;
  REFERENCE_TYPE_ADVISORY = 3;
  REFERENCE_TYPE_PATCH = 4;
  REFERENCE_TYPE_EXPLOIT = 5;
  REFERENCE_TYPE_VENDOR = 6;
  REFERENCE_TYPE_BLOG = 7;
  REFERENCE_TYPE_TOOL = 8;
}

enum RiskLevel {
  RISK_LEVEL_UNSPECIFIED = 0;
  RISK_LEVEL_INFORMATIONAL = 1;
  RISK_LEVEL_LOW = 2;
  RISK_LEVEL_MEDIUM = 3;
  RISK_LEVEL_HIGH = 4;
  RISK_LEVEL_CRITICAL = 5;
}

enum BusinessImpact {
  BUSINESS_IMPACT_UNSPECIFIED = 0;
  BUSINESS_IMPACT_NONE = 1;
  BUSINESS_IMPACT_LOW = 2;
  BUSINESS_IMPACT_MEDIUM = 3;
  BUSINESS_IMPACT_HIGH = 4;
  BUSINESS_IMPACT_CRITICAL = 5;
}

enum ExploitabilityLevel {
  EXPLOITABILITY_LEVEL_UNSPECIFIED = 0;
  EXPLOITABILITY_LEVEL_THEORETICAL = 1;
  EXPLOITABILITY_LEVEL_DIFFICULT = 2;
  EXPLOITABILITY_LEVEL_MODERATE = 3;
  EXPLOITABILITY_LEVEL_EASY = 4;
  EXPLOITABILITY_LEVEL_AUTOMATED = 5;
}

enum RemediationPriority {
  REMEDIATION_PRIORITY_UNSPECIFIED = 0;
  REMEDIATION_PRIORITY_P4_LOW = 1;
  REMEDIATION_PRIORITY_P3_MEDIUM = 2;
  REMEDIATION_PRIORITY_P2_HIGH = 3;
  REMEDIATION_PRIORITY_P1_CRITICAL = 4;
  REMEDIATION_PRIORITY_P0_EMERGENCY = 5;
}

// Service definitions
service VulnerabilityManagementService {
  rpc CreateVulnerabilityEvidence(CreateVulnerabilityEvidenceRequest) returns (CreateVulnerabilityEvidenceResponse);
  rpc GetVulnerabilityEvidence(GetVulnerabilityEvidenceRequest) returns (GetVulnerabilityEvidenceResponse);
  rpc ListVulnerabilityEvidence(ListVulnerabilityEvidenceRequest) returns (ListVulnerabilityEvidenceResponse);
  rpc UpdateVulnerabilityAssessment(UpdateVulnerabilityAssessmentRequest) returns (UpdateVulnerabilityAssessmentResponse);
  rpc UpdateVulnerabilityState(UpdateVulnerabilityStateRequest) returns (UpdateVulnerabilityStateResponse);
  rpc SearchVulnerabilities(SearchVulnerabilitiesRequest) returns (SearchVulnerabilitiesResponse);
  rpc ValidateEvidenceChain(ValidateEvidenceChainRequest) returns (ValidateEvidenceChainResponse);
  rpc GenerateVulnerabilityReport(GenerateVulnerabilityReportRequest) returns (GenerateVulnerabilityReportResponse);
}

// Request/Response messages
message CreateVulnerabilityEvidenceRequest {
  VulnerabilityEvidence evidence = 1;
  string analyst_id = 2;
  string source_system = 3;
}

message CreateVulnerabilityEvidenceResponse {
  string evidence_id = 1;
  string hash_chain = 2;
  google.protobuf.Timestamp created_at = 3;
}

message GetVulnerabilityEvidenceRequest {
  string evidence_id = 1;
  string tenant_id = 2;
}

message GetVulnerabilityEvidenceResponse {
  VulnerabilityEvidence evidence = 1;
}

message ListVulnerabilityEvidenceRequest {
  string tenant_id = 1;
  int32 page_size = 2;
  string page_token = 3;
  VulnerabilitySeverity filter_severity = 4;
  VulnerabilityState filter_state = 5;
  string filter_asset_id = 6;
}

message ListVulnerabilityEvidenceResponse {
  repeated VulnerabilityEvidence evidence_list = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

message UpdateVulnerabilityAssessmentRequest {
  string evidence_id = 1;
  string tenant_id = 2;
  VulnerabilityAssessment assessment = 3;
  string analyst_id = 4;
}

message UpdateVulnerabilityAssessmentResponse {
  string updated_evidence_id = 1;
  string new_hash_chain = 2;
  google.protobuf.Timestamp updated_at = 3;
}

message UpdateVulnerabilityStateRequest {
  string evidence_id = 1;
  string tenant_id = 2;
  VulnerabilityState new_state = 3;
  string reason = 4;
  string analyst_id = 5;
}

message UpdateVulnerabilityStateResponse {
  string updated_evidence_id = 1;
  string new_hash_chain = 2;
  google.protobuf.Timestamp updated_at = 3;
}

message SearchVulnerabilitiesRequest {
  string tenant_id = 1;
  string query = 2;
  repeated VulnerabilitySeverity severities = 3;
  repeated VulnerabilityState states = 4;
  repeated AssetType asset_types = 5;
  int32 limit = 6;
}

message SearchVulnerabilitiesResponse {
  repeated VulnerabilityEvidence matches = 1;
  int32 total_matches = 2;
}

message ValidateEvidenceChainRequest {
  string evidence_id = 1;
  string tenant_id = 2;
}

message ValidateEvidenceChainResponse {
  bool is_valid = 1;
  string validation_result = 2;
  repeated string chain_violations = 3;
}

message GenerateVulnerabilityReportRequest {
  string tenant_id = 1;
  repeated string evidence_ids = 2;
  ReportFormat format = 3;
  bool include_remediation = 4;
}

message GenerateVulnerabilityReportResponse {
  string report_id = 1;
  bytes report_data = 2;
  string download_url = 3;
}

enum ReportFormat {
  REPORT_FORMAT_UNSPECIFIED = 0;
  REPORT_FORMAT_PDF = 1;
  REPORT_FORMAT_JSON = 2;
  REPORT_FORMAT_XML = 3;
  REPORT_FORMAT_CSV = 4;
}